<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolution API Manager</title>
    <meta name="description" content="Gerenciador completo para inst√¢ncias da Evolution API">
    <meta name="author" content="Evolution API Manager">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="config.js" as="script">
    <link rel="preload" href="utils.js" as="script">
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Carregando Evolution API Manager...</p>
    </div>

    <!-- P√°gina de Login -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-form">
                <div class="login-header">
                    <h1>Evolution API Manager</h1>
                    <p>Gerencie suas inst√¢ncias WhatsApp com facilidade</p>
                </div>
                <form id="loginForm" novalidate>
                    <div class="input-group">
                        <label for="username">Usu√°rio</label>
                        <input type="text" id="username" name="username" required autocomplete="username" maxlength="50">
                        <div class="input-error"></div>
                    </div>
                    <div class="input-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password" maxlength="100">
                        <div class="input-error"></div>
                    </div>
                    <button type="submit" class="login-btn">
                        <span>Entrar</span>
                        <div class="btn-loading" style="display: none;"></div>
                    </button>
                </form>
                <div class="login-footer">
                    <p><small>Evolution API Manager v1.0.0</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- P√°gina de Administra√ß√£o -->
    <div id="adminPage" class="page">
        <header class="admin-header">
            <div class="header-left">
                <h1>Gerenciar Inst√¢ncias</h1>
                <div class="breadcrumbs" id="breadcrumbs"></div>
            </div>
            <div class="header-actions">
                <button id="refreshInstances" class="action-btn secondary" title="Atualizar Lista (Ctrl+R)">
                    <span class="btn-icon">üîÑ</span> Atualizar
                </button>
                <button id="exportData" class="action-btn primary" title="Exportar Backup (Ctrl+B)">
                    <span class="btn-icon">üì§</span> Exportar
                </button>
                <button id="logoutBtn" class="action-btn danger">
                    <span class="btn-icon">üö™</span> Sair
                </button>
            </div>
        </header>
        
        <div class="admin-container">
            <!-- Estat√≠sticas -->
            <div class="stats-section">
                <div class="stat-card total">
                    <div class="stat-icon">üì±</div>
                    <div class="stat-content">
                        <h3>Total de Inst√¢ncias</h3>
                        <span id="totalInstances" class="stat-number">0</span>
                    </div>
                </div>
                <div class="stat-card connected">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>Conectadas</h3>
                        <span id="connectedInstances" class="stat-number">0</span>
                    </div>
                </div>
                <div class="stat-card waiting">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <h3>Aguardando QR</h3>
                        <span id="waitingInstances" class="stat-number">0</span>
                    </div>
                </div>
                <div class="stat-card disconnected">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <h3>Desconectadas</h3>
                        <span id="disconnectedInstances" class="stat-number">0</span>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Cria√ß√£o de Inst√¢ncia -->
            <div class="create-instance-section">
                <h2>Criar Nova Inst√¢ncia</h2>
                <form id="createInstanceForm" novalidate>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="instanceName">Nome da Inst√¢ncia *</label>
                            <input type="text" id="instanceName" name="instanceName" required maxlength="50" 
                                   placeholder="Ex: Loja Principal">
                            <div class="input-error"></div>
                        </div>
                        <div class="input-group">
                            <label for="instanceDescription">Descri√ß√£o</label>
                            <input type="text" id="instanceDescription" name="instanceDescription" maxlength="200"
                                   placeholder="Ex: WhatsApp da Loja Principal - Centro">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="webhookUrl">URL do Webhook (N8N) - Opcional</label>
                            <input type="url" id="webhookUrl" name="webhookUrl" maxlength="500"
                                   placeholder="https://n8n.exemplo.com/webhook/...">
                            <small class="input-help">Configure um webhook para receber eventos autom√°ticos</small>
                        </div>
                        <div class="input-group">
                            <label for="instanceToken">Token Personalizado - Opcional</label>
                            <input type="text" id="instanceToken" name="instanceToken" maxlength="100"
                                   placeholder="Token para autentica√ß√£o">
                            <small class="input-help">Se n√£o informado, ser√° gerado automaticamente</small>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">
                        <span>Criar Inst√¢ncia</span>
                        <div class="btn-loading" style="display: none;"></div>
                    </button>
                </form>
            </div>

            <!-- Filtros -->
            <div class="filter-section">
                <div class="filter-group">
                    <label for="statusFilter">Filtrar por Status:</label>
                    <select id="statusFilter">
                        <option value="all">Todos os Status</option>
                        <option value="connected">Conectados</option>
                        <option value="waiting_qr">Aguardando QR</option>
                        <option value="disconnected">Desconectados</option>
                        <option value="error">Com Erro</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Buscar:</label>
                    <input type="text" id="searchFilter" placeholder="Nome da inst√¢ncia, ID ou descri√ß√£o..." maxlength="100">
                </div>
                <div class="filter-actions">
                    <button onclick="document.getElementById('searchFilter').value = ''; InstanceManager.applyFilters()" 
                            class="clear-filters-btn" title="Limpar filtros">
                        Limpar
                    </button>
                </div>
            </div>

            <!-- Lista de Inst√¢ncias -->
            <div class="instances-section">
                <h2>Inst√¢ncias Criadas</h2>
                <div id="instancesList" class="instances-list">
                    <!-- Lista ser√° preenchida pelo JavaScript -->
                    <div class="loading-placeholder">Carregando inst√¢ncias...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- P√°gina da Inst√¢ncia (Para o Cliente) -->
    <div id="instancePage" class="page">
        <div class="instance-container">
            <div class="instance-header">
                <div class="header-info">
                    <h1 id="instanceTitle">Conectar WhatsApp</h1>
                    <p id="instanceSubtitle">Escaneie o QR Code abaixo com seu WhatsApp</p>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator disconnected"></span>
                    <span class="status-text">Desconectado</span>
                </div>
                <button onclick="Navigation.goBack()" class="back-btn" title="Voltar (Alt+B)">
                    ‚Üê Voltar
                </button>
            </div>

            <div class="qr-section">
                <div id="qrContainer" class="qr-container">
                    <div class="qr-placeholder">QR Code ser√° exibido aqui</div>
                </div>
                <div class="qr-actions">
                    <button id="refreshQR" class="action-btn secondary" title="Atualizar QR Code">
                        üîÑ Atualizar QR
                    </button>
                    <button id="downloadQR" class="action-btn primary" style="display: none;" title="Baixar QR Code">
                        üíæ Download QR
                    </button>
                </div>
                <div class="qr-instructions">
                    <h4>Como conectar:</h4>
                    <ol>
                        <li>Abra o WhatsApp no seu celular</li>
                        <li>Toque em "Mais op√ß√µes" ou nos tr√™s pontos</li>
                        <li>Selecione "Dispositivos conectados"</li>
                        <li>Toque em "Conectar um dispositivo"</li>
                        <li>Aponte a c√¢mera para este c√≥digo QR</li>
                    </ol>
                </div>
            </div>

            <!-- Sistema de Tabs -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="config" title="Configura√ß√µes (Alt+1)">
                        ‚öôÔ∏è Configura√ß√£o
                    </button>
                    <button class="tab-btn" data-tab="messages" title="Mensagens (Alt+2)">
                        üí¨ Mensagens
                    </button>
                    <button class="tab-btn" data-tab="analytics" title="Relat√≥rios (Alt+3)">
                        üìä Relat√≥rios
                    </button>
                </div>

                <!-- Tab de Configura√ß√£o -->
                <div id="configTab" class="tab-content active">
                    <div class="config-section">
                        <div class="webhook-section">
                            <h3>Configura√ß√µes de Webhook</h3>
                            <div class="input-group">
                                <label for="webhookUrlInstance">URL do Webhook (N8N)</label>
                                <div class="input-with-action">
                                    <input type="url" id="webhookUrlInstance" maxlength="500"
                                           placeholder="https://n8n.exemplo.com/webhook/...">
                                    <button id="testWebhook" class="action-btn primary">Testar</button>
                                </div>
                                <small class="input-help">Configure um endpoint para receber eventos autom√°ticos</small>
                            </div>
                            <div class="webhook-status" id="webhookStatus">
                                <span class="status-indicator"></span>
                                <span class="status-text">N√£o configurado</span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2>Configura√ß√£o do Neg√≥cio</h2>
                            <form id="businessForm" class="business-form" novalidate>
                                <!-- Informa√ß√µes B√°sicas -->
                                <div class="form-group">
                                    <h3>üîπ Informa√ß√µes b√°sicas do neg√≥cio</h3>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label for="businessName">Nome do neg√≥cio *</label>
                                            <input type="text" id="businessName" required maxlength="100">
                                            <div class="input-error"></div>
                                        </div>
                                        <div class="input-group">
                                            <label for="businessAddress">Endere√ßo f√≠sico</label>
                                            <input type="text" id="businessAddress" maxlength="200">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label for="businessCity">Cidade/Estado *</label>
                                            <input type="text" id="businessCity" required maxlength="100">
                                            <div class="input-error"></div>
                                        </div>
                                        <div class="input-group">
                                            <label for="businessPhone">Telefone principal *</label>
                                            <input type="tel" id="businessPhone" required maxlength="20"
                                                   placeholder="(11) 99999-9999">
                                            <div class="input-error"></div>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label for="businessEmail">E-mail para contato</label>
                                            <input type="email" id="businessEmail" maxlength="100">
                                            <div class="input-error"></div>
                                        </div>
                                        <div class="input-group">
                                            <label for="businessWebsite">Website ou redes sociais</label>
                                            <input type="url" id="businessWebsite" maxlength="200"
                                                   placeholder="https://...">
                                        </div>
                                    </div>
                                </div>

                                <!-- Hor√°rio de Funcionamento -->
                                <div class="form-group">
                                    <h3>üîπ Hor√°rio de funcionamento</h3>
                                    <div class="schedule-container">
                                        <div class="schedule-day">
                                            <label class="day-label">Segunda-feira</label>
                                            <div class="time-inputs">
                                                <input type="time" id="mon_open" title="Hor√°rio de abertura">
                                                <span>√†s</span>
                                                <input type="time" id="mon_close" title="Hor√°rio de fechamento">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="mon_break_start" title="In√≠cio da pausa">
                                                <span>√†s</span>
                                                <input type="time" id="mon_break_end" title="Fim da pausa">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">Ter√ßa-feira</label>
                                            <div class="time-inputs">
                                                <input type="time" id="tue_open">
                                                <span>√†s</span>
                                                <input type="time" id="tue_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="tue_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="tue_break_end">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">Quarta-feira</label>
                                            <div class="time-inputs">
                                                <input type="time" id="wed_open">
                                                <span>√†s</span>
                                                <input type="time" id="wed_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="wed_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="wed_break_end">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">Quinta-feira</label>
                                            <div class="time-inputs">
                                                <input type="time" id="thu_open">
                                                <span>√†s</span>
                                                <input type="time" id="thu_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="thu_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="thu_break_end">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">Sexta-feira</label>
                                            <div class="time-inputs">
                                                <input type="time" id="fri_open">
                                                <span>√†s</span>
                                                <input type="time" id="fri_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="fri_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="fri_break_end">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">S√°bado</label>
                                            <div class="time-inputs">
                                                <input type="time" id="sat_open">
                                                <span>√†s</span>
                                                <input type="time" id="sat_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="sat_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="sat_break_end">
                                            </div>
                                        </div>
                                        <div class="schedule-day">
                                            <label class="day-label">Domingo</label>
                                            <div class="time-inputs">
                                                <input type="time" id="sun_open">
                                                <span>√†s</span>
                                                <input type="time" id="sun_close">
                                                <span class="break-label">Pausa:</span>
                                                <input type="time" id="sun_break_start">
                                                <span>√†s</span>
                                                <input type="time" id="sun_break_end">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Servi√ßos/Produtos -->
                                <div class="form-group">
                                    <h3>üîπ Servi√ßos ou produtos</h3>
                                    <div id="servicesContainer">
                                        <!-- Servi√ßos ser√£o adicionados dinamicamente -->
                                    </div>
                                    <button type="button" id="addService" class="add-btn">
                                        ‚ûï Adicionar Servi√ßo
                                    </button>
                                </div>

                                <!-- Agendamentos -->
                                <div class="form-group">
                                    <h3>üîπ Agendamentos</h3>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label for="appointmentType">Tipo de agendamento</label>
                                            <select id="appointmentType">
                                                <option value="online">Online</option>
                                                <option value="presencial">Apenas presencial</option>
                                                <option value="ambos">Online e presencial</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="simultaneousAppointments">Agendamentos simult√¢neos</label>
                                            <input type="number" id="simultaneousAppointments" min="1" max="10" value="1">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label for="appointmentInterval">Tempo m√≠nimo entre agendamentos (min)</label>
                                            <input type="number" id="appointmentInterval" min="15" step="15" value="30" max="480">
                                        </div>
                                        <div class="input-group">
                                            <label for="cancellationPolicy">Pol√≠tica de cancelamento</label>
                                            <textarea id="cancellationPolicy" rows="3" maxlength="500"
                                                     placeholder="Ex: Cancelamentos devem ser feitos com 24h de anteced√™ncia..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Atendimento WhatsApp -->
                                <div class="form-group">
                                    <h3>üîπ Atendimento via WhatsApp</h3>
                                    <div class="input-group">
                                        <label for="welcomeMessage">Mensagem de sauda√ß√£o inicial *</label>
                                        <textarea id="welcomeMessage" rows="4" required maxlength="1000"
                                                 placeholder="Ex: Ol√°! Bem-vindo ao [Nome do Neg√≥cio]. Como posso ajud√°-lo hoje?"></textarea>
                                        <div class="input-error"></div>
                                    </div>
                                    <div class="input-group">
                                        <label for="autoResponse">Informa√ß√µes importantes para resposta autom√°tica</label>
                                        <textarea id="autoResponse" rows="4" maxlength="1000"
                                                 placeholder="Ex: Endere√ßo, promo√ß√µes, formas de pagamento, etc."></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label for="faq">Perguntas frequentes</label>
                                        <textarea id="faq" rows="6" maxlength="2000"
                                                 placeholder="Liste as perguntas mais comuns e suas respostas"></textarea>
                                    </div>
                                </div>

                                <button type="submit" class="submit-btn">
                                    <span>Salvar Configura√ß√µes</span>
                                    <div class="btn-loading" style="display: none;"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Tab de Mensagens -->
                <div id="messagesTab" class="tab-content">
                    <div class="messages-section">
                        <h3>Enviar Mensagem de Teste</h3>
                        <div class="message-form">
                            <div class="input-group">
                                <label for="testNumber">N√∫mero de destino (com DDI)</label>
                                <input type="tel" id="testNumber" placeholder="5511999999999" maxlength="20">
                                <small class="input-help">Formato: DDI + DDD + N√∫mero (sem espa√ßos ou s√≠mbolos)</small>
                            </div>
                            <div class="input-group">
                                <label for="testMessage">Mensagem</label>
                                <textarea id="testMessage" rows="4" maxlength="1000"
                                         placeholder="Digite sua mensagem de teste... (Enter para enviar)"></textarea>
                                <div class="textarea-counter">
                                    <span id="messageCounter">0/1000</span>
                                </div>
                            </div>
                            <button id="sendTestMessage" class="send-btn">
                                <span>üì§ Enviar Mensagem</span>
                                <div class="btn-loading" style="display: none;"></div>
                            </button>
                        </div>
                    </div>

                    <div class="message-history">
                        <div class="history-header">
                            <h3>Hist√≥rico de Mensagens</h3>
                            <div class="history-actions">
                                <button onclick="MessageManager.loadInstanceMessages(appState.currentInstance.id)" 
                                        class="action-btn secondary small" title="Atualizar mensagens">
                                    üîÑ Atualizar
                                </button>
                                <button onclick="MessageManager.clearMessageHistory(appState.currentInstance.id)" 
                                        class="action-btn danger small" title="Limpar hist√≥rico">
                                    üóëÔ∏è Limpar
                                </button>
                            </div>
                        </div>
                        <div id="messagesList" class="messages-list">
                            <div class="loading-placeholder">Carregando mensagens...</div>
                        </div>
                    </div>
                </div>

                <!-- Tab de Relat√≥rios -->
                <div id="analyticsTab" class="tab-content">
                    <div class="analytics-section">
                        <div class="analytics-header">
                            <h3>Relat√≥rios da Inst√¢ncia</h3>
                            <button onclick="Analytics.updateInstanceAnalytics()" class="action-btn secondary small">
                                üîÑ Atualizar (F5)
                            </button>
                        </div>
                        
                        <div class="analytics-cards">
                            <div class="analytics-card">
                                <div class="card-icon">üì§</div>
                                <div class="card-content">
                                    <h4>Mensagens Enviadas (24h)</h4>
                                    <span id="messagesSent24h" class="card-number">0</span>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">üì•</div>
                                <div class="card-content">
                                    <h4>Mensagens Recebidas (24h)</h4>
                                    <span id="messagesReceived24h" class="card-number">0</span>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">‚è±Ô∏è</div>
                                <div class="card-content">
                                    <h4>Tempo Online</h4>
                                    <span id="uptime" class="card-number">0h 0m</span>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">üïí</div>
                                <div class="card-content">
                                    <h4>√öltima Atividade</h4>
                                    <span id="lastActivity" class="card-number">Nunca</span>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">üí¨</div>
                                <div class="card-content">
                                    <h4>Total de Mensagens</h4>
                                    <span id="totalMessagesAnalytics" class="card-number">0</span>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">üìä</div>
                                <div class="card-content">
                                    <h4>Taxa de Resposta</h4>
                                    <span id="responseRate" class="card-number">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-section">
                            <h4>Exportar Dados</h4>
                            <div class="export-buttons">
                                <button id="exportMessages" class="action-btn primary">
                                    üìÑ Exportar Mensagens
                                </button>
                                <button id="exportConfig" class="action-btn secondary">
                                    ‚öôÔ∏è Exportar Configura√ß√µes
                                </button>
                                <button id="exportAll" class="action-btn success">
                                    üì¶ Exportar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Import/Export -->
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Importar/Exportar Dados</h3>
                <span class="modal-close" title="Fechar (Esc)">&times;</span>
            </div>
            <div class="modal-body">
                <textarea id="modalTextarea" rows="15" 
                         placeholder="Cole os dados aqui para importar ou copie os dados exportados..."></textarea>
                <div class="modal-help">
                    <p><strong>Dica:</strong> Voc√™ pode importar backups completos, configura√ß√µes de inst√¢ncia ou hist√≥rico de mensagens em formato JSON.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modalCancel" class="cancel-btn">Cancelar</button>
                <button id="modalConfirm" class="confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEM IMPORTANTE -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="state.js"></script>
    <script src="evolution-api.js"></script>
    <script src="auth.js"></script>
    <script src="navigation.js"></script>
    <script src="instance-manager.js"></script>
    <script src="instance-page.js"></script>
    <script src="message-manager.js"></script>
    <script src="analytics.js"></script>
    <script src="business-config.js"></script>
    <script src="modal.js"></script>
    <script src="script.js"></script>

    <!-- Service Worker para PWA (opcional) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registrado'))
                    .catch(error => console.log('Erro no SW:', error));
            });
        }
    </script>

    <!-- Remove loading overlay -->
    <script>
        window.addEventListener('load', () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                setTimeout(() => {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 300);
                }, 500);
            }
        });
    </script>
</body>
</html>